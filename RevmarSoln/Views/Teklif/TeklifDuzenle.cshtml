@using SahinRektefiyeSoln.Models.HelperModels;
@model SahinRektefiyeSoln.Models.ViewModels.Teklif.TeklifDuzenlePageModel
@{
    ViewBag.Title = "TeklifDuzenle";
    Layout = "~/Views/Shared/_Layout.cshtml";
    string MusteriDesc = string.Empty;

    if (Model.teklifler.Musteri != null)
    {
        MusteriDesc = Model.teklifler.Musteri.MusteriTipi == "B" ? (Model.teklifler.Musteri.MusteriAdi.ToString() + " " + Model.teklifler.Musteri.MusteriSoyadi.ToString()) : Model.teklifler.Musteri.KurumAdi.ToString();
    }

    int kalemCounter = 1;

    bool SwSms = false;
    bool SwArama = false;
    bool SwMail = false;

    if (Model.teklifler.Musteri.MusteriTelefon != null)
    {
        SwSms = Model.teklifler.Musteri.MusteriTelefon.Where(x => x.SwOnaySms == true).Count() > 0 ? true : false;
        SwArama = Model.teklifler.Musteri.MusteriTelefon.Where(x => x.SwOnayArama == true).Count() > 0 ? true : false;
    }

    if (Model.teklifler.Musteri.MusteriMail != null)
    {
        SwMail = Model.teklifler.Musteri.MusteriMail.Where(x => x.SwOnay == true).Count() > 0 ? true : false;
    }


    int TeklifStatuId = Model.teklifler.TeklifStatuId;

}
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/1.6.2/css/buttons.dataTables.min.css" />
<script src="https://cdn.datatables.net/buttons/1.6.2/js/dataTables.buttons.min.js"></script>

<script>
	$(document).ready(function () {


        var teklifStatuId = @TeklifStatuId;

        if (teklifStatuId != @SahinRektefiyeSoln.Models.Parameters.TeklifAcikStatu) //İptal ise tüm sayfayı disable aç
		{
			$('#txtMusteriIstek').attr('disabled','disabled');
			$('#btnMusteriIstekEkle').attr('disabled','disabled');
			$('#fileInputhdn').attr('disabled','disabled');
			$('#btnDosyaEkle').attr('disabled','disabled');
			$('#btnTeklifIscilikEkle').attr('disabled', 'disabled');
			$('#btnDyiEkle').attr('disabled', 'disabled');
			$('#btnTeklifParcaEkle').attr('disabled','disabled');
			$('#btnIskontoEkle').attr('disabled','disabled');
			$('#btnTeklifPaketEkle').attr('disabled','disabled');
			$('#btnSecimleriSil').attr('disabled','disabled');
            $('#btnTeklifiIptalEt').addClass('w3-disabled');
			$('#btnKapat').addClass('w3-disabled');
            $('#btnTeklifNotEkle').addClass('w3-disabled');
            $('#btnTeklifDonustur').addClass('w3-disabled');
            $('#TeklifNot').addClass('w3-disabled');
			$('.aisEmriIptalLine').addClass('w3-disabled');
            $('.btnkalemIskonto').addClass('w3-disabled');
		}


		$('#btnClear').click(function () {
			$('#fileInputhdn').val('');
			$('#blah').attr('src', '');
			$('#btnClear').removeClass('w3-show').addClass('w3-hide');
			$('#txtpath').val('');
			$('.image-upload-wrap').show();
			$("#WorkOrderImagesList").empty();
		});

        $('#btnTeklifIscilikEkle').click(function () {

            $('#divTeklifIscilikEkle').load('@Url.Action("TeklifIscilikEkle", "Teklif", new { TeklifId = Model.teklifler.TeklifId })');

			document.getElementById('ModalIscilikEkle').style.display = 'block';

			return false;

        });

        $('#btnTeklifDonustur').click(function () {

            $('#divIsEmrineDonustur').load('@Url.Action("TeklifIsEmriDonustur", "Teklif", new { TeklifId = Model.teklifler.TeklifId })');

            document.getElementById('ModalIsEmrineDonustur').style.display = 'block';

			return false;

        });

        $('#btnSecimleriSil').click(function () {
			var checkboxes = $('.kalemWillDelete');
			var kalemIds = [];
			checkboxes.each(function (index) {
				if ($(this)[0].checked) {
					kalemIds.push($(this)[0].getAttribute('kalemid'));
				}
			});

			var urlSecilenleriSil = '@Url.Action("TeklifSeciliParcalariSil", "Teklif")';

			var data = {
				teklifId : '@Model.teklifler.TeklifId',
				kalemIds: kalemIds
			};

			console.log(data);
			WaitBlockUI(2000, 'Seçili parçalar siliniyor...');
			$.ajax({
				type: "POST",
				url: urlSecilenleriSil,
				content: "application/json; charset=utf-8",
				dataType: "json",
				data: data,//JSON.stringify(),
				success: function (d) {
					if (d.result == 1)
						location.reload();
					else {
						alert(d.message);
					}
				},
				error: function (xhr, textStatus, errorThrown) {
					alert('Error2 \n' + data);
				}
			});
        });

        $('#btnTeklifiIptalEt').click(function () {

            if (teklifStatuId != @SahinRektefiyeSoln.Models.Parameters.TeklifAcikStatu) {
				return false;
			}

			document.getElementById('ModalTeklifIptalEt').style.display = 'block';

			return false;

		});

        $('#btnIskontoEkle').click(function () {

            document.getElementById('ModalIskontoEkle').style.display = 'block';

            return false;

        });

        $('.btnkalemIskonto').click(function () {

            var teklifKalemId = $(this)[0].getAttribute('TeklifKalemId');
            $('#kalemIskontoIsEmriId').val(teklifKalemId);

            document.getElementById('ModalKalemIskontoEkle').style.display = 'block';
        });

        $('#btnTeklifParcaEkle').click(function () {

			$('#divTeklifParcaEkle').load('@Url.Action("TeklifStokKartEkle", "Teklif", new { TeklifId  = Model.teklifler.TeklifId })');

			document.getElementById('ModalParcaEkle').style.display = 'block';

			return false;

        });

        $('#btnTeklifPaketEkle').click(function () {

            $('#divTeklifPaketEkle').load('/Teklif/TeklifPaketEkle?TeklifId=@Model.teklifler.TeklifId&CompanyId=@Model.teklifler.Arac.CompanyId');

			document.getElementById('ModalPaketEkle').style.display = 'block';

			return false;

        });

        $('#btnDyiEkle').click(function () {

			$('#divDyiEkle').load('@Url.Action("TeklifDyiEkle", "Teklif", new { TeklifId = Model.teklifler.TeklifId})');

			document.getElementById('ModalDyiEkle').style.display = 'block';

			return false;

		});

        $('#tableIsEmriKalemleri').attr("style", "");

        $('#tableIsEmriKalemleri').DataTable({
            paging: false,
            dom: 'Bfrtip',
            buttons: [
                {
                    text: 'Hepsini Seç',
                    action: function (e, dt, node, config) {
                        //alert('Button activated');

                        var boxes = $('.kalemWillDelete');

                        boxes.each(function (index) {
                            $(this)[0].checked = true;

                        });
                    },
                    className: ''
                }
            ],
            "processing": true,
            "filter": true,
            "language": {

                "sEmptyTable": "Tabloda herhangi bir veri mevcut değil",

                "oPaginate": { "sFirst": "İlk", "sLast": "Son", "sNext": "İleri", "sPrevious": "Geri" },

                "select": { "rows": { "_": "%d kayıt seçildi", "0": "", "1": "1 kayıt seçildi" } },

                "sSearch": "",

                "selectAll": "Tümünü Seç",

                "sSearchPlaceholder": "Filtrele",

                "sLengthMenu": "_MENU_",

                "sLoadingRecords": "Yükleniyor...",

                "sProcessing": "İşleniyor...",

                "sZeroRecords": "Eşleşen kayıt bulunamadı...",

                "sInfo": "_TOTAL_ kayıttan _START_ - _END_ arasındaki kayıtlar.",

                "sInfoFiltered": "(_MAX_ kayıt içerisinden bulunan)",

                "sInfoEmpty": "Kayıt Yok",

                "sInfoPostFix": "",

                "sInfoThousands": ".",

                "sDecimal": ","

            }
            ,
            "footerCallback": function (row, data, start, end, display) {
                var api = this.api(), data;

                // Remove the formatting to get integer data for summation
                var intVal = function (i) {
                    return typeof i === 'string' ?
                        //i.replace(/[\$,]/g, '') * 1 :
                        i.replace(',', '.') * 1 :
                        typeof i === 'number' ?
                            i : 0;
                };

                // Total over all pages
                total = api
                    .column(14)
                    .data()
                    .reduce(function (a, b) {
                        return intVal(a) + intVal(b);
                    }, 0);

                // Total over this page
                pageTotal = api
                    .column(14, { page: 'current' })
                    .data()
                    .reduce(function (a, b) {
                        return intVal(a) + intVal(b);
                    }, 0);

                // Update footer
                $(api.column(14).footer()).html(
                    //'₺' + pageTotal + ' ( $' + total + ' total)'
                    total.toFixed(2) + ' ₺'
                );
            }
        });

	});
	function showToaster(resultType, body, header) {
		if (resultType == "Error") {
			toastr.error(body, header);
		}
		else if (resultType == "Success") {
			toastr.success(body, header);
		}
		else if (resultType == "Info") {
			toastr.info(body, header);
		}
		else if (resultType == "Warning") {
			toastr.warning(body, header);
		}

	}

    function onPdfExport() {
        window.open("@Request.Url.GetLeftPart(UriPartial.Authority)/Teklif/TeklifPrintView?TeklifId=@Model.teklifler.TeklifId");
	}

	@*function onIsEmriExport() {
		window.open("@Request.Url.GetLeftPart(UriPartial.Authority)/IsEmri/IsEmriDetayPrint?IsEmriId=@Model.teklifler.TeklifId");
	}*@

	function readURL(input) {
		$("#WorkOrderImagesList").empty();
		$('#blah').removeClass("w3-hide").addClass('w3-show');
		for (var i = 0; i <= input.files.length; i++) {
			if (input.files && input.files[i]) {
				var reader = new FileReader();

				$('#blah').attr('src', '/Images/Loading1.gif');
				$('#barim').removeClass('w3-hide').addClass('w3-show');
				reader.readAsDataURL(input.files[i]);
				var elem = document.getElementById("myBar");
				var width = 1;
				var id = setInterval(frame, 5);
				function frame() {
					if (width >= 100) {
						clearInterval(id);
					} else {
						width++;
						elem.style.width = width + '%';
						document.getElementById("demo").innerHTML = width * 1 + '%';
					}
				}
				reader.onload = function (e) {

					$('.image-upload-wrap').hide();
					setTimeout(function () {
						//$('#blah').attr('src', e.target.result);
						var x = document.createElement("IMG");
						x.setAttribute("class", "w3-quarter w3-padding w3-border w3-margin-right")
						x.setAttribute("src", e.target.result);

						x.setAttribute("alt", "The Pulpit Rock");
						$('#WorkOrderImagesList').append(x);
						$('#barim').removeClass('w3-show').addClass('w3-hide');
						$('#blah').removeClass("w3-show").addClass('w3-hide');
					}, 500);

				}

			}

			if ($('#blah')[0].currentSrc = null) {
				$('#btnClear').removeClass("w3-show").addClass("w3-hide");
			} else {
				$('#btnClear').removeClass("w3-hide").addClass("w3-show");
			}



			$(" <div class='w3-col l3 m6 w3-margin-bottom'><div class='w3-display-container' id='" + i + '"> asdfasdf </div></div>"').appendTo('#Images');
		}

	}

	function WaitBlockUI(milisaniye, message) {

		$.blockUI({
			css: {
				border: 'none',
				padding: '15px',
				backgroundColor: '#000',
				'-webkit-border-radius': '10px',
				'-moz-border-radius': '10px',
				opacity: .5,
				color: '#fff'
			},
			message: message
		});

		setTimeout($.unblockUI, milisaniye);

	}
</script>
<style>
    #tableIsEmriKalemleri {
        font-family: tahoma;
    }

    #divIsEmriDetay {
        font-family: tahoma;
    }
</style>

<style>

    .file-upload-input {
        position: absolute;
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        outline: none;
        opacity: 0;
        cursor: pointer;
    }

    .image-upload-wrap:hover {
        background-color: #f1f1f1 !important;
    }

    .drag-text {
        text-align: center;
    }

        .drag-text h3 {
            font-weight: 100;
            text-transform: uppercase;
            color: #15824B;
            padding: 60px 0;
        }
</style>
@using Vereyon.Web;
@Html.Action("SetPageHeader", "Admin", new { pageTitle = "Teklif Detay Ekranı", pagePermission = "XXXXX" })

<div class="w3-panel">
    <div class="w3-row-padding w3-card">
        <div class="w3-row w3-row-padding  w3-margin-top">
            @Html.RenderFlashMessages()
        </div>
        <div class="w3-panel w3-light-grey w3-round" style="margin-top: 0px;margin-bottom: 10px;font-family:Arial">
            <div class="w3-quarter">
                &nbsp;
                <div class="w3-left"><p>Teklif Numarası :  	@(String.Format("{0:000000}", Model.teklifler.TeklifNo))</p></div>
            </div>
            <div class="w3-right w3-quarter">
                <div class="w3-left">
                    <p>Teklif Giriş Tarihi: @Model.teklifler.TeklifTarihi.ToShortDateString() </p>

                </div>

                <div class="w3-right w3-margin-top">
                    @*<span class="w3-right w3-padding-lr-4" style="cursor:alias" title="İş Emri Dökümünü Yazdır"> &nbsp;<i class="fa fa-print w3-text-green" aria-hidden="true" onclick="onIsEmriExport();"></i></span>*@
                    <span class="w3-right" style="cursor:alias" title="İş Emrini Yazdır"> &nbsp;<i class="fa fa-print w3-text-blue" aria-hidden="true" onclick="onPdfExport();"></i></span>

                </div>
            </div>

        </div>

        <div class="w3-row w3-border w3-round">

            <!--Araç Bilgileri-->
            <div class="w3-third w3-padding-right">
                <table class=" w3-striped w3-white" cellpadding="4" cellspacing="2" width="100%">
                    <thead>
                        <tr>
                            <td colspan="100%" class="w3-center w3-round w3-blue">Araç Bilgileri</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="2">@Model.teklifler.Arac.Companies.Name</td>
                            <td colspan="2">@Model.teklifler.Arac.Vehicles.Name</td>
                        </tr>
                        <tr>
                            <td colspan="4">
                                @Model.teklifler.Arac.AracModelAdi
                            </td>
                        </tr>
                        <tr>
                            <td>Şasi No</td>
                            <td>@Model.teklifler.Arac.SaseNo</td>
                            <td>Plaka</td>
                            <td>@Model.teklifler.Arac.Plaka</td>
                        </tr>
                        <tr>
                            <td>Km</td>
                            <td>
                                <style>
                                    #inputKm {
                                        background: transparent;
                                        border: none;
                                    }
                                </style>
                                <input id="inputKm" class="w3-hover-white w3-round w3-padding-left" type="text" value="@Model.teklifler.Arac.Km" oldKmValue="@Model.teklifler.Arac.Km" />
                            </td>
                            <td>Model Yılı</td>
                            <td>@Model.teklifler.Arac.ModelYili</td>
                        </tr>
                        <tr>
                            <td colspan="2">Trafik Çıkış Trh : @(Model.teklifler.Arac.AracDetay.TrafigeCikisTarihi.HasValue == true ? Model.teklifler.Arac.AracDetay.TrafigeCikisTarihi.Value.ToShortDateString() : "Belirtilmemiş")</td>
                            <td colspan="2">Renk : @Model.teklifler.Arac.Renkler.Aciklamasi</td>
                        </tr>
                        <tr>
                            <td colspan="2">Egzos Muayne Baş/Bit Trh.</td>
                            <td colspan="2">
                                @(Model.teklifler.Arac.AracDetay.EgsozMuayeneBsgTrh.HasValue == true ? Model.teklifler.Arac.AracDetay.EgsozMuayeneBsgTrh.Value.ToShortDateString() : " ")
                                -
                                @(Model.teklifler.Arac.AracDetay.EgsozMuayeneBtsTrh.HasValue == true ? Model.teklifler.Arac.AracDetay.EgsozMuayeneBtsTrh.Value.ToShortDateString() : " ")
                            </td>
                        </tr>
                        <tr>
                            <td colspan="2">Muayene Baş/Bit Trh.</td>
                            <td colspan="2">
                                @(Model.teklifler.Arac.AracDetay.MuayeneBsgTrh.HasValue == true ? Model.teklifler.Arac.AracDetay.MuayeneBsgTrh.Value.ToShortDateString() : " ")
                                -
                                @(Model.teklifler.Arac.AracDetay.MuayeneBtsTrh.HasValue == true ? Model.teklifler.Arac.AracDetay.MuayeneBtsTrh.Value.ToShortDateString() : " ")
                            </td>
                        </tr>
                    </tbody>
                </table>

            </div>
            <!--Müşteri Bilgileri-->
            <div class="w3-third w3-padding-right">
                <table class=" w3-striped w3-white" cellpadding="4" cellspacing="2" width="100%">
                    <thead>
                        <tr>
                            <td colspan="100%" class="w3-center w3-round w3-blue">Müşteri Bilgileri</td>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="4" class="w3-center">
                                @MusteriDesc
                            </td>
                        </tr>
                        <tr>
                            <td>
                                Telefon
                            </td>
                            <td>
                                @if (Model.teklifler.Musteri.MusteriTelefon.Count > 0)
                                {
                                    <label>@Model.teklifler.Musteri.MusteriTelefon.FirstOrDefault().TelefonNumarasi</label>
                                }
                                else
                                {
                                    <label>-</label>
                                }
                            </td>
                            <td>Muhasebe Kodu</td>
                            <td>@Model.teklifler.Musteri.MuhasebeKodu</td>
                        </tr>
                        <tr>

                            <td>Tc/Vergi No</td>
                            <td>
                                @if (Model.teklifler.Musteri.MusteriTipi == "B")
                                {
                                    <label>@Model.teklifler.Musteri.TCKN</label>
                                }
                                else
                                {
                                    <label>@Model.teklifler.Musteri.VergiNo</label>
                                }

                            </td>
                            <td>
                                Vergi Dairesi
                            </td>
                            <td>
                                @(Model.teklifler.Musteri.iller1 != null ? Model.teklifler.Musteri.iller1.sehir : "")
                            </td>

                        </tr>
                        <tr>

                            <td>İletişim İzni</td>
                            <td colspan="3">
                                Sms &nbsp; <i class="fa @(SwSms== false ? "fa-times-circle w3-text-red" : "fa-check-circle w3-text-green") w3-large" aria-hidden="true"></i> &nbsp;
                                Arama &nbsp; <i class="fa @(SwArama== false ? "fa-times-circle w3-text-red" : "fa-check-circle w3-text-green") w3-large" aria-hidden="true"></i>&nbsp;
                                Mail &nbsp;  <i class="fa @(SwMail== false ? "fa-times-circle w3-text-red" : "fa-check-circle w3-text-green") w3-large" aria-hidden="true"></i>

                            </td>
                        </tr>
                        <tr>
                            <td colspan="4">
                                Adres : @Model.teklifler.Musteri.Adres
                            </td>

                        </tr>
                    </tbody>
                </table>
            </div>

        </div>

        <!--######### Teklif Notları #########-->
        <div class="w3-row w3-padding-top w3-padding-bottom">
            @using (Html.BeginForm("TeklifNotEkle", "Teklif", FormMethod.Post))
            {
                <input type="hidden" name="TeklifId"  value="@Model.teklifler.TeklifId" />
                <div class="w3-col m11 l11">
                    @Html.TextAreaFor(model => model.teklifler.TeklifNot, new { @class = "w3-input w3-border w3-round", maxlength = "1024", @placeholder = "Buraya Teklif Notları Ekleyebilirsiniz..", autocomplete = "off", name = "TeklifNot" , id= "TeklifNot" })
                </div>
                <div class="w3-col m1 l1 w3-padding">
                    <button type="submit" class="w3-button w3-green" id="btnTeklifNotEkle">Ekle</button>
                </div>
            }

        </div>


        <!--######### İş Emri Kalemleri #########-->
        <div class="w3-row w3-margin-bottom ">
            <div class="w3-row">
                <div class="w3-threequarter">
                    <h5>İŞÇİLİK ve PARÇA DETAYI</h5>
                </div>

            </div>
            <div class="w3-section">
                <button class="w3-btn w3-ripple w3-blue" id="btnTeklifIscilikEkle"><i class="fa fa-plus" aria-hidden="true"></i> İşçilik</button>
                <button class="w3-btn w3-ripple w3-blue" id="btnDyiEkle"><i class="fa fa-plus" aria-hidden="true"></i> DYI</button>
                <button class="w3-btn w3-ripple w3-blue" id="btnTeklifParcaEkle"><i class="fa fa-plus" aria-hidden="true"></i> Parça</button>
                <button class="w3-btn w3-ripple w3-blue" id="btnIskontoEkle"><i class="fa fa-plus" aria-hidden="true"></i> Genel İskonto</button>
                <button class="w3-btn w3-ripple w3-blue" id="btnTeklifPaketEkle"><i class="fa fa-plus" aria-hidden="true"></i> Bakım/Tamir Paketleri</button>
                <button class="w3-btn w3-ripple w3-red " id="btnSecimleriSil"><i class="fa fa-times w3-text-white" aria-hidden="true"></i> Seçilenleri Sil</button>


                <button class="w3-btn w3-ripple w3-red w3-right" id="btnTeklifiIptalEt"><i class="fa fa-times w3-text-white" aria-hidden="true"></i> Teklifi İptal Et</button>
                <button class="w3-btn w3-ripple w3-green w3-right" id="btnTeklifDonustur"><i class="fa fa-check-square-o w3-text-white" aria-hidden="true"></i> İş Emrine Dönüştür</button>

            </div>
            <div class="w3-row">
                <div class="w3-padding w3-panel">

                    <table class="w3-table-all w3-margin-top w3-margin-bottom" id="tableIsEmriKalemleri">
                        <thead>
                            <tr>
                                <td>#</td>
                                <td>#</td>
                                <td>#</td>
                                <td>Tip</td>
                                <td>İş/Parça No</td>
                                <td>İş/Parça Adı</td>
                                <td>Adet/Saat</td>
                                <td>Kdv Hariç Birim Fiyat</td>
                                <td>İskonto %</td>
                                <td>İskonto Tutarı</td>
                                <td>KDVsiz İskontolu Birim Fiyat</td>
                                <td>KDV Oranı</td>
                                @*<td>KDV Tutarı</td>*@
                                <td>KDVli Birim Fiyat</td>
                                <td>T.KDV Tutarı</td>
                                <td>Kdv Hariç Tutar</td>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.teklifKalemleri.Count > 0)
                            {
                                foreach (var kalem in Model.teklifKalemleri.Where(x => x.KalemTipi == "I"))
                                {
                                    <tr>
                                        <td>
                                            @kalemCounter
                                        </td>
                                        <td>
                                            <input type="checkbox" class="kalemWillDelete" KalemId="@kalem.TeklifKalemId" />
                                        </td>
                                        <td>
                                            @*@if (Model.isEmri.IsEmriStatuId != SahinRektefiyeSoln.Models.Parameters.IsEmriIptalStatu)
                                                {*@
                                            <a href="/Teklif/TeklifKalemSil?TeklifKalemId=@kalem.TeklifKalemId" title="Teklifden kalemi silmek için tıklayınız." class="w3-text-red aisEmriIptalLine"><i class="fa fa-times-circle-o w3-hover-opacity" aria-hidden="true"></i></a>
                                            @*}
                                                else
                                                {
                                                    <button href="/IsEmri/IsEmriKalemSil?IsEmriKalemId=@kalem.IsEmriKalemId" title="İş emrinden kalemi silmek için tıklayınız." class="w3-text-red aisEmriIptalLine"><i class="fa fa-times-circle-o w3-hover-opacity" aria-hidden="true"></i></button>
                                                }*@
                                        </td>
                                        <td>İşçilik</td>
                                        <td>@kalem.IscilikKodu</td>
                                        <td>@kalem.IscilikAdi</td>
                                        <td>@String.Format("{0:0.00}", kalem.Miktar)</td>
                                        <td>
                                            @if (kalem.isDYI)
                                            {
                                                <label>@String.Format("{0:0.00}", kalem.kdvHaricBirimFiyati)</label>
                                            }
                                            else
                                            {
                                                <label>@String.Format("{0:0.00}", kalem.kdvHaricBirimFiyati)</label>
                                            }
                                        </td>
                                        <td>
                                            <a title="Kalem İskonto Oranı girmek için tıklayın" class="w3-text-red btnkalemIskonto w3-right" TeklifKalemId="@kalem.TeklifKalemId">
                                                <i class="fa fa-cart-arrow-down w3-hover-opacity" aria-hidden="true"></i>
                                            </a>
                                            <label class="w3-left">@String.Format("{0:0.00}", kalem.kalemIskontoOrani * 100) </label>
                                        </td>
                                        <td>@String.Format("{0:0.00}", kalem.kalemIskontoTutari)</td>
                                        <td>@String.Format("{0:0.00}", kalem.KdvHaricIskontoluBFiyat)</td>
                                        <td>@String.Format("{0:0.00}", kalem.KdvOrani * 100)</td>
                                        <td>@String.Format("{0:0.00}", kalem.KdvDahilBirimFiyat)</td>
                                        <td>@String.Format("{0:0.00}", kalem.ToplamKdvliTutari)</td>
                                        <td>@String.Format("{0:0.00}", kalem.KdvHaricTutar)</td>
                                    </tr>
                                    kalemCounter += 1;
                                }
                                foreach (var kalem in Model.teklifKalemleri.Where(x => x.KalemTipi == "P"))
                                {
                                    <tr>
                                        <td>
                                            @kalemCounter
                                        </td>
                                        <td>
                                            <input type="checkbox" class="kalemWillDelete" KalemId="@kalem.TeklifKalemId" />
                                        </td>
                                        <td>
                                            @*@if (Model.teklifler.IsEmriStatuId != SahinRektefiyeSoln.Models.Parameters.IsEmriIptalStatu)
                                                {*@
                                            <a href="/Teklif/TeklifKalemSil?TeklifKalemId=@kalem.TeklifKalemId" title="Teklifden kalemi silmek için tıklayınız." class="w3-text-red aisEmriIptalLine"><i class="fa fa-times-circle-o w3-hover-opacity" aria-hidden="true"></i></a>
                                            @* }
                                                else
                                                {
                                                    <button href="/IsEmri/IsEmriKalemSil?IsEmriKalemId=@kalem.IsEmriKalemId" title="İş emrinden kalemi silmek için tıklayınız." class="w3-text-red aisEmriIptalLine"><i class="fa fa-times-circle-o w3-hover-opacity" aria-hidden="true"></i></button>
                                                }*@
                                        </td>
                                        <td>Parça</td>
                                        <td>@kalem.ParcaNo</td>
                                        <td>@kalem.ParcaAdi</td>
                                        <td>
                                            <a onclick="document.getElementById('depoParcaTeslim-@kalem.TeklifKalemId').style.display='block'" class="w3-hover-opacity" style="cursor: pointer;" title="Parça Teslim Durumunu Görüntülemek İçin Tıklayınız..">@kalem.Miktar</a>
                                            <div id="depoParcaTeslim-@kalem.TeklifKalemId" class="w3-modal">
                                                <div class="w3-modal-content">
                                                    <div class="w3-container">
                                                        <span onclick="document.getElementById('depoParcaTeslim-@kalem.TeklifKalemId').style.display='none'" class="w3-button w3-display-topright">&times;</span>
                                                        <div class="w3-row w3-center">
                                                            @*<p>@kalem.ParcaNo - @kalem.ParcaAdi parçasından @kalem.TeslimEdilenMiktar adet/miktar teslim edilmiştir</p>*@

                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>@String.Format("{0:0.00}", kalem.kdvHaricBirimFiyati)</td>
                                        <td>
                                            <a title="Kalem İskonto Oranı girmek için tıklayın" class="w3-text-red btnkalemIskonto w3-right" TeklifKalemId="@kalem.TeklifKalemId"><i class="fa fa-cart-arrow-down w3-hover-opacity" aria-hidden="true"></i></a>
                                            <label class="w3-left">@(kalem.kalemIskontoOrani * 100)</label>
                                        </td>
                                        <td>@String.Format("{0:0.00}", kalem.kalemIskontoTutari)</td>
                                        <td>@String.Format("{0:0.00}", kalem.KdvHaricIskontoluBFiyat)</td>
                                        <td>@String.Format("{0:0.00}", kalem.KdvOrani * 100)</td>
                                        @*<td>@String.Format("{0:0.00}",kalem.KdvBirimTutari)</td>*@
                                        <td>@String.Format("{0:0.00}", kalem.KdvDahilBirimFiyat)</td>
                                        <td>@String.Format("{0:0.00}", kalem.ToplamKdvliTutari)</td>
                                        <td>@String.Format("{0:0.00}", kalem.KdvHaricTutar)</td>
                                    </tr>
                                    kalemCounter += 1;
                                }
                            }
                            else
                            {
                                <tr>
                                    <td class="w3-center w3-text-red" colspan="13"> <b>TEKLIFE PARÇA VEYA İŞÇİLİK EKLENMEMİŞTİR. </b></td>
                                    <td style="display:none;"></td>
                                    <td style="display:none;"></td>
                                    <td style="display:none;"></td>
                                    <td style="display:none;"></td>
                                    <td style="display:none;"></td>
                                    <td style="display:none;"></td>
                                    <td style="display:none;"></td>
                                    <td style="display:none;"></td>
                                    <td style="display:none;"></td>
                                    <td style="display:none;"></td>
                                    <td style="display:none;"></td>
                                    <td style="display:none;"></td>
                                    <td style="display:none;"></td>
                                    <td style="display:none;"></td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="14" style="text-align:right">Toplam:</th>
                                <th></th>
                            </tr>
                        </tfoot>
                    </table>

                </div>
            </div>

        </div>

        <!--İş Emri Fiyat Bilgileri-->
        <div class="w3-row w3-margin w3-light-gray w3-round ">

            <div id="divIsEmriDetay">
                <div class="w3-quarter w3-right">

                    <table class="w3-right">
                        @*<tr>
                                <td>İndirim Öncesi Tutar</td>
                                <td class="w3-right"> <b>@(Math.Round(Convert.ToDecimal(ViewBag.IndirimsizTutar), 2))  ₺</b></td>
                            </tr>*@
                        <tr>
                            <td>Toplam Müşteri</td>
                            <td class="w3-right"><b>@String.Format("{0:0.00}", Model.teklifKalemleri.Sum(x => x.KdvHaricTutar)) ₺ </b></td>
                        </tr>
                        <tr>
                            <td>Kdv Tutarı</td>
                            <td class="w3-right"><b>@String.Format("{0:0.00}", (Model.teklifKalemleri.Sum(x => x.ToplamKdvliTutari))) ₺</b></td>
                        </tr>
                        <tr>
                            <td>Kdv'li Toplam </td>
                            <td class="w3-right"><b>@String.Format("{0:0.00}", (Model.teklifKalemleri.Sum(x => x.ToplamKdvliTutari) + Model.teklifKalemleri.Sum(x => x.KdvHaricTutar))) ₺</b></td>
                        </tr>
                    </table>

                </div>
                <div class="w3-quarter w3-right">
                    <table class="w3-right">
                        <tr>
                            <td width="50%">Parça Satır</td>
                            <td class="w3-right"><b>@String.Format("{0:0.00}", Model.teklifKalemleri.Where(x => x.KalemTipi == "P").Count())</b></td>
                        </tr>
                        <tr>
                            <td>Toplam Parça</td>
                            <td class="w3-right"><b> @String.Format("{0:0.00}", Model.teklifKalemleri.Where(x => x.KalemTipi == "P").Sum(x => x.KdvHaricTutar)) ₺</b></td>
                        </tr>
                        <tr>
                            <td>İşçilik Satır</td>
                            <td class="w3-right"><b>@String.Format("{0:0.00}", Model.teklifKalemleri.Where(x => x.KalemTipi == "I").Count()) </b></td>
                        </tr>
                        <tr>
                            <td>Toplam İşçilik</td>
                            <td class="w3-right"><b>@String.Format("{0:0.00}", Model.teklifKalemleri.Where(x => x.KalemTipi == "I").Sum(x => x.KdvHaricTutar)) ₺</b></td>
                        </tr>

                    </table>
                </div>


            </div>


        </div>

    </div>
</div>


<div id="modal01" class="w3-modal w3-animate-zoom" onclick="this.style.display='none'">
    <img class="w3-modal-content" id="viewImage">
</div>

<div id="ModalIscilikEkle" class="w3-modal">
    <div class="w3-modal-content">
        <header class="w3-container w3-teal">
            <span onclick="document.getElementById('ModalIscilikEkle').style.display = 'none';location.reload();"
                  class="w3-button w3-display-topright">&times;</span>
            <h2>Teklif'e İşçilik Ekle</h2>
        </header>
        <div class="w3-container">
            <div class="w3-row w3-margin" id="divTeklifIscilikEkle">

            </div>
        </div>
    </div>
</div>

<div id="ModalIsEmrineDonustur" class="w3-modal">
    <div class="w3-modal-content">
        <header class="w3-container w3-teal">
            <span onclick="document.getElementById('ModalIsEmrineDonustur').style.display = 'none';location.reload();"
                  class="w3-button w3-display-topright">&times;</span>
            <h2>Teklif'i İş Emrine Dönüştür</h2>
        </header>
        <div class="w3-container">
            <div class="w3-row w3-margin" id="divIsEmrineDonustur">

            </div>
        </div>
    </div>
</div>

<div id="ModalDyiEkle" class="w3-modal">
    <div class="w3-modal-content">
        <header class="w3-container w3-teal">
            <span onclick="document.getElementById('ModalDyiEkle').style.display = 'none';location.reload();"
                  class="w3-button w3-display-topright">&times;</span>
            <h2>Teklif'e Dış İşçilik Ekle</h2>
        </header>
        <div class="w3-container">
            <div class="w3-row w3-margin" id="divDyiEkle">

            </div>
        </div>

    </div>
</div>


<div id="ModalParcaEkle" class="w3-modal">
    <div class="w3-modal-content">
        <header class="w3-container w3-teal">
            <span onclick="document.getElementById('ModalParcaEkle').style.display = 'none';location.reload();"
                  class="w3-button w3-display-topright">&times;</span>
            <h2>Teklif'e Parça Ekle</h2>
        </header>
        <div class="w3-container">
            <div class="w3-row w3-margin" id="divTeklifParcaEkle">

            </div>
        </div>
    </div>
</div>


<div id="ModalPaketEkle" class="w3-modal">
    <div class="w3-modal-content">
        <header class="w3-container w3-teal">
            <span onclick="document.getElementById('ModalPaketEkle').style.display='none'"
                  class="w3-button w3-display-topright">&times;</span>
            <h2>İş Emri'ne Paket Ekle</h2>
        </header>
        <div class="w3-container">
            <div class="w3-row w3-margin" id="divTeklifPaketEkle">

            </div>
        </div>
    </div>
</div>


<div id="ModalParcaYonet" class="w3-modal">
    <div class="w3-modal-content">
        <header class="w3-container w3-teal">
            <span onclick="document.getElementById('ModalParcaYonet').style.display = 'none'; location.reload();"
                  class="w3-button w3-display-topright">&times;</span>
            <h2>İş Emri'ne Parça Yönet</h2>
        </header>
        <div class="w3-container">
            <div class="w3-row w3-margin" id="divParcaYonet">

            </div>
        </div>
    </div>
</div>

<div id="ModalIskontoEkle" class="w3-modal">
    <div class="w3-modal-content">
        <header class="w3-container w3-teal">
            <span onclick="document.getElementById('ModalIskontoEkle').style.display='none'"
                  class="w3-button w3-display-topright">&times;</span>
            <h2>Teklif''e İskonto Ekle</h2>
        </header>
        <div class="w3-container">
            <div class="w3-row w3-margin" id="divIskontoEkle">
                @using (Html.BeginForm("TeklifGenelIskontoUygula", "Teklif", FormMethod.Post))
                {
                    <input type="hidden" name="teklifId" value="@Model.teklifler.TeklifId" />
                    <div class="w3-container">
                        <div class="w3-third w3-padding">
                            <label>Parça İndirim Oranı %</label>
                            <input type="number" class="w3-input w3-border w3-round onlynumeric" max="100" min="0" name="parcaIskonto" value="0" />
                        </div>
                        <div class="w3-third w3-padding">
                            <label>İşçilik İndirim Oranı %</label>
                            <input type="number" class="w3-input w3-border w3-round onlynumeric" max="100" min="0" name="iscilikIskonto" value="0" />
                        </div>
                        <div class="w3-third w3-padding">
                            <br />
                            <button class="w3-btn w3-ripple w3-green w3-round" type="submit"><i class="fa fa-cart-arrow-down" aria-hidden="true"></i> İndirim Yap</button>
                        </div>
                    </div>
                }

            </div>
        </div>
    </div>
</div>

<div id="ModalKalemIskontoEkle" class="w3-modal">
    <div class="w3-modal-content">
        <header class="w3-container w3-teal">
            <span onclick="document.getElementById('ModalKalemIskontoEkle').style.display='none'"
                  class="w3-button w3-display-topright">&times;</span>
            <h2>Kalem'e İskonto Ekle</h2>
        </header>
        <div class="w3-container">
            <div class="w3-row w3-margin" id="divKalemeIskontoEkle">
                @using (Html.BeginForm("TeklifKalemineIskontoUygula", "Teklif", FormMethod.Post))
                {
                    <input type="hidden" name="kalemIskontoIsEmriId" id="kalemIskontoIsEmriId" />
                    <div class="w3-container">
                        <div class="w3-third w3-padding">
                            <label>İndirim Oranı %</label>
                            <input type="number" class="w3-input w3-border w3-round onlynumeric" max="100" min="0" name="kalemIskontoOrani" value="0" />
                        </div>
                        <div class="w3-third w3-padding">
                            <br />
                            <button class="w3-btn w3-ripple w3-green w3-round" type="submit"><i class="fa fa-cart-arrow-down" aria-hidden="true"></i> İndirim Yap</button>
                        </div>
                    </div>
                }

            </div>
        </div>
    </div>
</div>


<div id="ModalTeklifIptalEt" class="w3-modal">
    <div class="w3-modal-content">
        <header class="w3-container w3-red">
            <span onclick="document.getElementById('ModalTeklifIptalEt').style.display='none'"
                  class="w3-button w3-display-topright">&times;</span>
            <h2>Teklif İptal Et</h2>
        </header>
        <div class="w3-container">
            <div class="w3-row w3-margin">
                @using (Html.BeginForm("TeklifIptalEt", "Teklif", FormMethod.Post))
                {
                    <input type="hidden" name="TeklifId" value="@Model.teklifler.TeklifId" />
                    <div class="w3-container">
                        <div class="w3-row w3-padding">
                            <label>Teklif Neden İptal Ediliyor?</label>
                            <textarea class="w3-input w3-border w3-round" maxlength="1024" autocomplete="off" name="teklifIptalAciklamasi"></textarea>
                        </div>
                        <div class="w3-row w3-padding">
                            <br />
                            <button class="w3-btn w3-ripple w3-green w3-round w3-right" type="submit"><i class="fa fa-times" aria-hidden="true"></i> İptal Et</button>
                        </div>
                    </div>
                }

            </div>
        </div>
    </div>
</div>